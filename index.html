<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>üìà Live Trading Analyzer PRO + UT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --panel: #020617;
      --card: #020617;
      --border: #1f2937;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.15);
      --accent-alt: #38bdf8;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.15);
      --muted: #6b7280;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --shadow-soft: 0 20px 40px rgba(0, 0, 0, 0.7);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 1200px;
      margin: auto;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(3, 7, 18, 0.98));
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 16px 20px 8px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      backdrop-filter: blur(16px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 36px;
      height: 36px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 0, #22c55e 0, #16a34a 35%, #4ade80 60%, #22c55e 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 25px rgba(34, 197, 94, 0.7);
      font-size: 20px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-weight: 600;
      letter-spacing: 0.03em;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .brand-title span.highlight {
      color: #22c55e;
    }

    .brand-subtitle {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .badge-live {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(34, 197, 94, 0.6);
      background: linear-gradient(135deg, rgba(22, 163, 74, 0.18), rgba(22, 163, 74, 0.03));
      font-size: 11px;
      color: #bbf7d0;
    }

    .dot-pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
      position: relative;
    }

    .dot-pulse::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: inherit;
      border: 1px solid rgba(74, 222, 128, 0.8);
      animation: ping 1.3s cubic-bezier(0, 0, 0.2, 1) infinite;
    }

    @keyframes ping {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.9); opacity: 0; }
    }

    .connection-status {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(75, 85, 99, 0.7);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.22), rgba(15, 23, 42, 0.7));
    }

    .connection-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #f97316;
    }

    .connection-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .connection-dot.off {
      background: #ef4444;
      box-shadow: 0 0 10px rgba(239, 68, 68, 0.7);
    }

    .toolbar {
      padding: 8px 20px 14px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .toolbar-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
      color: var(--muted);
    }

    .field label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .field-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    select, button {
      font-family: inherit;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top, #0b1120, #020617);
      color: var(--text);
      font-size: 13px;
      padding: 7px 14px;
      outline: none;
      min-width: 0;
    }

    select {
      padding-right: 28px;
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #6b7280 50%),
        linear-gradient(135deg, #6b7280 50%, transparent 50%);
      background-position:
        calc(100% - 13px) 11px,
        calc(100% - 8px) 11px;
      background-size: 5px 5px, 5px 5px;
      background-repeat: no-repeat;
    }

    button {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(34, 197, 94, 0.7);
      background: radial-gradient(circle at top left, #22c55e, #15803d);
      color: #ecfdf3;
      font-weight: 600;
      letter-spacing: 0.03em;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding-inline: 16px;
      cursor: pointer;
      box-shadow: 0 0 18px rgba(34, 197, 94, 0.45);
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.08s ease;
    }

    button span.icon { font-size: 15px; }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.04);
      box-shadow: 0 0 22px rgba(34, 197, 94, 0.7);
    }

    button:active {
      transform: translateY(0);
      filter: brightness(0.98);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
    }

    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 14px;
      padding: 14px 16px 16px;
    }

    @media (max-width: 880px) {
      main { grid-template-columns: minmax(0, 1fr); }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(31, 41, 55, 0.9), rgba(15, 23, 42, 0.98));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(31, 41, 55, 0.95);
      box-shadow: 0 16px 28px rgba(0, 0, 0, 0.7);
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(34, 197, 94, 0.12), transparent 50%);
      opacity: 0.8;
      pointer-events: none;
    }

    .card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 6px;
      position: relative;
      z-index: 1;
    }

    .card-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pill {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .card-body {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    @media (max-width: 640px) {
      .metrics-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .metric {
      padding: 8px 10px;
      border-radius: 14px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(55, 65, 81, 0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 62px;
    }

    .metric.primary { grid-column: span 2; }

    .metric-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.13em;
    }

    .metric-value {
      font-size: 22px;
      line-height: 1.1;
      font-weight: 600;
    }

    .metric-value.sm { font-size: 15px; }

    .metric-sub {
      font-size: 11px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chip {
      border-radius: var(--radius-pill);
      padding: 2px 7px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
    }

    .metric-variation {
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .metric-variation.up { color: #4ade80; }
    .metric-variation.down { color: #fb7185; }
    .metric-variation.neutral { color: var(--muted); }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
    }

    .dot.green { background: #22c55e; box-shadow: 0 0 8px rgba(34,197,94,0.9); }
    .dot.red   { background: #ef4444; box-shadow: 0 0 8px rgba(239,68,68,0.8); }
    .dot.gray  { background: #6b7280; }

    .signal-banner {
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: radial-gradient(circle at left, rgba(34, 197, 94, 0.05), rgba(15, 23, 42, 1));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
    }

    .signal-banner .tag {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.14em;
      text-transform: uppercase;
    }

    .tag-buy {
      background: var(--accent-soft);
      border: 1px solid rgba(34, 197, 94, 0.9);
      color: #bbf7d0;
    }

    .tag-sell {
      background: var(--danger-soft);
      border: 1px solid rgba(239, 68, 68, 0.9);
      color: #fecaca;
    }

    .tag-flat {
      background: rgba(148, 163, 184, 0.16);
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
    }

    .signal-detail { display:flex; flex-direction:column; gap:2px; }
    .signal-detail span { font-size:11px; color:var(--text-soft); }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 6px;
    }

    @media (max-width: 640px) {
      .stats-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    .stat-card {
      padding: 7px 8px;
      border-radius: 12px;
      border: 1px solid rgba(55, 65, 81, 0.95);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 1));
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-height: 50px;
    }

    .stat-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .stat-value {
      font-size: 16px;
      font-weight: 600;
    }

    .stat-sub { font-size:10px; color:var(--text-soft); }
    .stat-value.green { color:#4ade80; }
    .stat-value.red   { color:#fb7185; }

    .signals-table-wrapper {
      max-height: 230px;
      overflow: hidden auto;
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 1));
    }

    table { width:100%; border-collapse:collapse; font-size:11px; }

    thead {
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(to bottom, rgba(15,23,42,1), rgba(15,23,42,0.96));
    }

    th, td {
      padding: 6px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      white-space: nowrap;
    }

    th {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      font-weight: 500;
      font-size: 10px;
    }

    tbody tr:nth-child(even) { background: rgba(15,23,42,0.9); }
    tbody tr:hover           { background: rgba(51,65,85,0.8); }

    .badge {
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge-buy {
      background: var(--accent-soft);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.9);
    }

    .badge-sell {
      background: var(--danger-soft);
      color: #fecaca;
      border: 1px solid rgba(239, 68, 68, 0.9);
    }

    .badge-flat {
      background: rgba(148, 163, 184, 0.16);
      color: #e5e7eb;
      border: 1px solid rgba(148, 163, 184, 0.8);
    }

    footer {
      padding: 8px 16px 10px;
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .footer-section {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .footer-section span.label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 10px;
      color: #6b7280;
    }

    .mono {
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .hint { color:#9ca3af; }
    .hint strong { color:#e5e7eb; font-weight:600; }

    ::-webkit-scrollbar { width:6px; height:6px; }
    ::-webkit-scrollbar-track { background:#020617; }
    ::-webkit-scrollbar-thumb { background:#4b5563; border-radius:999px; }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <div class="brand-icon">‚ö°</div>
        <div class="brand-text">
          <div class="brand-title">
            LIVE<span class="highlight">SCANNER</span> PRO
          </div>
          <div class="brand-subtitle">EMAS ¬∑ UT STYLE ¬∑ BACKTEST EN TIEMPO REAL</div>
        </div>
      </div>
      <div class="header-right">
        <div class="badge-live">
          <div class="dot-pulse"></div>
          EN TIEMPO REAL
        </div>
        <div class="connection-status">
          <div id="statusDot" class="connection-dot off"></div>
          <span id="statusText">Desconectado</span>
        </div>
      </div>
    </header>

    <div class="toolbar">
      <div class="toolbar-group">
        <div class="field">
          <label>S√≠mbolo</label>
          <div class="field-row">
            <select id="symbolSelect">
              <option value="BTCUSDT">BTC/USDT</option>
              <option value="ETHUSDT">ETH/USDT</option>
              <option value="BNBUSDT">BNB/USDT</option>
              <option value="PEPEUSDT">PEPE/USDT</option>
              <option value="SOLUSDT">SOL/USDT</option>
              <option value="LINKUSDT">LINK/USDT</option>
              <option value="ADAUSDT">ADA/USDT</option>
              <option value="ZECUSDT">ZEC/USDT</option>
              <option value="DASHUSDT">DASH/USDT</option>
              <option value="MLNUSDT">MLN/USDT</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label>Timeframe</label>
          <div class="field-row">
            <select id="intervalSelect">
              <option value="1m">1m</option>
              <option value="5m">5m</option>
              <option value="15m">15m</option>
            </select>
          </div>
        </div>
      </div>

      <div class="toolbar-group">
        <div class="field">
          <label>EMAs / UT</label>
          <div class="field-row">
            <span class="chip">EMA 9/21 + ATR stop (UT style)</span>
          </div>
        </div>
        <button id="connectBtn">
          <span class="icon">üöÄ</span>
          <span>Conectar / Reset</span>
        </button>
      </div>
    </div>

    <main>
      <!-- LEFT -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">SNAPSHOT DE MERCADO</div>
          <div class="pill" id="symbolLabel">BTCUSDT ¬∑ 1M</div>
        </div>
        <div class="card-body">
          <div class="metrics-grid">
            <div class="metric primary">
              <div class="metric-label">Precio actual</div>
              <div id="priceValue" class="metric-value">‚Äì ‚Äì ‚Äì</div>
              <div class="metric-sub">
                <span id="priceChange" class="metric-variation neutral">
                  <span class="dot gray"></span>
                  Sin variaci√≥n
                </span>
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">Cierre vela actual</div>
              <div id="lastClose" class="metric-value sm mono">‚Äì ‚Äì ‚Äì</div>
              <div class="metric-sub">
                <span id="lastCandleInfo">Esperando datos‚Ä¶</span>
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">EMA 9 vs EMA 21</div>
              <div class="metric-value sm">
                <span id="ema9Value" class="mono">‚Äì ‚Äì ‚Äì</span>
                &nbsp;/&nbsp;
                <span id="ema21Value" class="mono">‚Äì ‚Äì ‚Äì</span>
              </div>
              <div class="metric-sub">
                <span id="emaState">Sin c√°lculo suficiente‚Ä¶</span>
              </div>
            </div>
          </div>

          <!-- UT style metric -->
          <div class="metric">
            <div class="metric-label">UT Bot (demo ATR stop)</div>
            <div id="utTrendLabel" class="metric-value sm">‚Äì ‚Äì ‚Äì</div>
            <div class="metric-sub">
              <span id="utLineText">L√≠nea din√°mica: ‚Äì ‚Äì ‚Äì</span>
            </div>
          </div>

          <div class="signal-banner" id="signalBanner">
            <div id="signalTag" class="tag tag-flat">Sin se√±al</div>
            <div class="signal-detail">
              <span id="signalText">Esperando el primer cruce/se√±al‚Ä¶</span>
              <span id="signalMeta" class="mono">‚Äì ‚Äì ‚Äì</span>
            </div>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="card-header">
          <div class="card-title">HISTORIAL & ESTAD√çSTICAS</div>
          <div class="pill">EMAs ¬∑ UT style ¬∑ Trades simulados</div>
        </div>
        <div class="card-body">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Se√±ales</div>
              <div id="statSignals" class="stat-value">0</div>
              <div class="stat-sub">Total LONG + SHORT</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Trades</div>
              <div id="statTrades" class="stat-value">0</div>
              <div class="stat-sub">Se cierra al cambio de color</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Winrate</div>
              <div id="statWinrate" class="stat-value green">‚Äì</div>
              <div class="stat-sub">% trades con PnL &gt; 0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Pnl Promedio</div>
              <div id="statAvgPnl" class="stat-value">‚Äì</div>
              <div class="stat-sub">% por trade</div>
            </div>
          </div>

          <div class="signals-table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Tipo</th>
                  <th>Estrategia</th>
                  <th>Precio</th>
                  <th>EMA9</th>
                  <th>EMA21</th>
                </tr>
              </thead>
              <tbody id="signalsBody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <div class="footer-section">
        <span class="label">Stream</span>
        <span id="footerStream" class="mono">‚Äì</span>
      </div>
      <div class="footer-section">
        <span class="label">Posici√≥n</span>
        <span id="footerPosition" class="mono">Sin posici√≥n abierta</span>
      </div>
      <div class="footer-section">
        <span class="hint">
          Guard√° este archivo como <strong>trading-analyzer-pro-ut.html</strong> y abrilo en el navegador.
        </span>
      </div>
    </footer>
  </div>

  <script>
    // ===== ESTADO GLOBAL =====
    let socket = null;
    let closes = [];
    let ema9 = null;
    let ema21 = null;
    let lastPrice = null;
    let lastSignal = null;
    let prevEma9 = null;
    let prevEma21 = null;

    // UT style (ATR trailing stop)
    const ATR_PERIOD = 10;
    const ATR_MULT = 1.5;
    let atr = null;
    let prevClose = null;
    let utTrend = null;     // "LONG" | "SHORT" | "FLAT"
    let utLine = null;

    // Backtest live
    let signals = [];       // { type, price, ema9, ema21, ts, strategy }
    let trades = [];        // { side, entry, exit, pnlPct, tsEntry, tsExit }
    let openPosition = null; // { side, entryPrice, tsEntry }

    // ===== HELPERS =====
    function formatNumber(num, decimals = 2) {
      if (num === null || num === undefined || Number.isNaN(num)) return "‚Äì";
      return Number(num).toLocaleString("en-US", {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function formatPriceBySymbol(symbol, price) {
      if (price === null || price === undefined) return "‚Äì ‚Äì ‚Äì";
      const s = symbol.toUpperCase();
      if (s.endsWith("USDT")) {
        if (s.startsWith("PEPE")) return formatNumber(price, 6);
        if (price >= 1000) return formatNumber(price, 1);
        return formatNumber(price, 3);
      }
      return formatNumber(price, 6);
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString("es-AR", { hour12: false });
    }

    function computeEMA(prevEma, price, k) {
      if (prevEma === null) return price;
      return (price - prevEma) * k + prevEma;
    }

    // ===== DOM =====
    const symbolSelect = document.getElementById("symbolSelect");
    const intervalSelect = document.getElementById("intervalSelect");
    const connectBtn = document.getElementById("connectBtn");

    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const symbolLabel = document.getElementById("symbolLabel");

    const priceValue = document.getElementById("priceValue");
    const priceChange = document.getElementById("priceChange");
    const lastCloseEl = document.getElementById("lastClose");
    const lastCandleInfo = document.getElementById("lastCandleInfo");
    const ema9Value = document.getElementById("ema9Value");
    const ema21Value = document.getElementById("ema21Value");
    const emaState = document.getElementById("emaState");

    const utTrendLabel = document.getElementById("utTrendLabel");
    const utLineText = document.getElementById("utLineText");

    const signalTag = document.getElementById("signalTag");
    const signalText = document.getElementById("signalText");
    const signalMeta = document.getElementById("signalMeta");
    const signalsBody = document.getElementById("signalsBody");

    const footerStream = document.getElementById("footerStream");
    const footerPosition = document.getElementById("footerPosition");

    const statSignals = document.getElementById("statSignals");
    const statTrades = document.getElementById("statTrades");
    const statWinrate = document.getElementById("statWinrate");
    const statAvgPnl = document.getElementById("statAvgPnl");

    // ===== UI STATE =====
    function setConnectionState(state, message) {
      statusDot.classList.remove("ok", "off");
      if (state === "connected") {
        statusDot.classList.add("ok");
        statusText.textContent = message || "Conectado";
      } else if (state === "connecting") {
        statusText.textContent = message || "Conectando‚Ä¶";
      } else if (state === "error") {
        statusDot.classList.add("off");
        statusText.textContent = message || "Error de conexi√≥n";
      } else {
        statusDot.classList.add("off");
        statusText.textContent = message || "Desconectado";
      }
    }

    function setPriceDisplay(symbol, price) {
      if (price === null) {
        priceValue.textContent = "‚Äì ‚Äì ‚Äì";
        return;
      }
      priceValue.textContent = formatPriceBySymbol(symbol, price);
    }

    function setPriceChangeDisplay(basePrice, currentPrice) {
      if (!basePrice || !currentPrice) {
        priceChange.className = "metric-variation neutral";
        priceChange.innerHTML = '<span class="dot gray"></span> Sin variaci√≥n';
        return;
      }
      const diff = currentPrice - basePrice;
      const pct = (diff / basePrice) * 100;

      if (Math.abs(pct) < 0.01) {
        priceChange.className = "metric-variation neutral";
        priceChange.innerHTML = '<span class="dot gray"></span> ' + pct.toFixed(2) + "%";
      } else if (pct > 0) {
        priceChange.className = "metric-variation up";
        priceChange.innerHTML = '<span class="dot green"></span> +' + pct.toFixed(2) + "%";
      } else {
        priceChange.className = "metric-variation down";
        priceChange.innerHTML = '<span class="dot red"></span> ' + pct.toFixed(2) + "%";
      }
    }

    function updateEmaDisplay(symbol) {
      ema9Value.textContent = formatPriceBySymbol(symbol, ema9);
      ema21Value.textContent = formatPriceBySymbol(symbol, ema21);

      if (ema9 === null || ema21 === null) {
        emaState.textContent = "Esperando m√°s velas para estabilizar EMAs‚Ä¶";
        return;
      }
      if (ema9 > ema21) {
        emaState.textContent = "Sesgo alcista (EMA 9 por encima de EMA 21)";
      } else if (ema9 < ema21) {
        emaState.textContent = "Sesgo bajista (EMA 9 por debajo de EMA 21)";
      } else {
        emaState.textContent = "EMAs pr√°cticamente iguales (zona de equilibrio)";
      }
    }

    function updateUtDisplay(symbol) {
      if (!utTrend || utLine === null || atr === null) {
        utTrendLabel.textContent = "Sin tendencia definida";
        utLineText.textContent = "L√≠nea din√°mica: ‚Äì ‚Äì ‚Äì";
        return;
      }
      if (utTrend === "LONG") {
        utTrendLabel.textContent = "UT: LONG (sesgo alcista)";
      } else if (utTrend === "SHORT") {
        utTrendLabel.textContent = "UT: SHORT (sesgo bajista)";
      } else {
        utTrendLabel.textContent = "UT: FLAT";
      }
      utLineText.textContent =
        "L√≠nea din√°mica: " + formatPriceBySymbol(symbol, utLine);
    }

    function setSignalBanner(type, price, symbol, ts) {
      let cls = "tag-flat";
      let label = "Sin se√±al";
      let text = "Esperando el primer cruce/se√±al‚Ä¶";

      if (type === "BUY") {
        cls = "tag-buy";
        label = "LONG";
        text = "Se√±al alcista (cambio de sesgo).";
      } else if (type === "SELL") {
        cls = "tag-sell";
        label = "SHORT";
        text = "Se√±al bajista (cambio de sesgo).";
      }

      signalTag.className = "tag " + cls;
      signalTag.textContent = label;
      signalText.textContent = text;

      if (type && price != null) {
        signalMeta.textContent =
          `${formatTime(ts)} ¬∑ ${symbol.toUpperCase()} @ ${formatPriceBySymbol(symbol, price)}`;
      } else {
        signalMeta.textContent = "‚Äì ‚Äì ‚Äì";
      }
    }

    function appendSignalRow(type, price, symbol, ema9Val, ema21Val, ts, strategy) {
      const tr = document.createElement("tr");

      const tdTime = document.createElement("td");
      tdTime.textContent = formatTime(ts);
      tr.appendChild(tdTime);

      const tdType = document.createElement("td");
      const badge = document.createElement("span");
      badge.classList.add("badge");
      if (type === "BUY") {
        badge.classList.add("badge-buy");
        badge.textContent = "LONG";
      } else if (type === "SELL") {
        badge.classList.add("badge-sell");
        badge.textContent = "SHORT";
      } else {
        badge.classList.add("badge-flat");
        badge.textContent = "FLAT";
      }
      tdType.appendChild(badge);
      tr.appendChild(tdType);

      const tdStrat = document.createElement("td");
      tdStrat.textContent = strategy || "EMA";
      tr.appendChild(tdStrat);

      const tdPrice = document.createElement("td");
      tdPrice.textContent = formatPriceBySymbol(symbol, price);
      tr.appendChild(tdPrice);

      const tdEma9 = document.createElement("td");
      tdEma9.textContent = formatPriceBySymbol(symbol, ema9Val);
      tr.appendChild(tdEma9);

      const tdEma21 = document.createElement("td");
      tdEma21.textContent = formatPriceBySymbol(symbol, ema21Val);
      tr.appendChild(tdEma21);

      signalsBody.insertBefore(tr, signalsBody.firstChild);
      while (signalsBody.rows.length > 50) {
        signalsBody.deleteRow(signalsBody.rows.length - 1);
      }
    }

    function updatePositionFooter(symbol) {
      if (!openPosition) {
        footerPosition.textContent = "Sin posici√≥n abierta";
        return;
      }
      const sideText = openPosition.side === "LONG" ? "LONG" : "SHORT";
      const entry = formatPriceBySymbol(symbol, openPosition.entryPrice);
      footerPosition.textContent =
        `${sideText} @ ${entry} ¬∑ ${formatTime(openPosition.tsEntry)}`;
    }

    function updateStatsUI() {
      const totalSignals = signals.length;
      const totalTrades = trades.length;

      statSignals.textContent = totalSignals;
      statTrades.textContent = totalTrades;

      if (totalTrades === 0) {
        statWinrate.textContent = "‚Äì";
        statAvgPnl.textContent = "‚Äì";
        statWinrate.classList.remove("green", "red");
        return;
      }

      const wins = trades.filter(t => t.pnlPct > 0).length;
      const winrate = (wins / totalTrades) * 100;

      let sumPnl = 0;
      for (const t of trades) sumPnl += t.pnlPct;
      const avgPnl = sumPnl / totalTrades;

      statWinrate.textContent = winrate.toFixed(1) + "%";
      statAvgPnl.textContent = avgPnl.toFixed(2) + "%";

      statWinrate.classList.remove("green", "red");
      if (winrate >= 50) statWinrate.classList.add("green");
      else statWinrate.classList.add("red");
    }

    function handleTradeLogic(signalType, price, ts) {
      if (signalType !== "BUY" && signalType !== "SELL") return;
      const sideNew = signalType === "BUY" ? "LONG" : "SHORT";

      if (openPosition && openPosition.side !== sideNew) {
        let pnlPct = 0;
        if (openPosition.side === "LONG") {
          pnlPct = ((price - openPosition.entryPrice) / openPosition.entryPrice) * 100;
        } else if (openPosition.side === "SHORT") {
          pnlPct = ((openPosition.entryPrice - price) / openPosition.entryPrice) * 100;
        }

        trades.push({
          side: openPosition.side,
          entry: openPosition.entryPrice,
          exit: price,
          pnlPct,
          tsEntry: openPosition.tsEntry,
          tsExit: ts
        });

        openPosition = null;
      }

      if (!openPosition) {
        openPosition = {
          side: sideNew,
          entryPrice: price,
          tsEntry: ts
        };
      }

      updatePositionFooter(symbolSelect.value);
      updateStatsUI();
    }

    function registerSignal(type, price, symbol, ema9Val, ema21Val, ts, strategy) {
      signals.push({ type, price, ema9: ema9Val, ema21: ema21Val, ts, strategy });
      appendSignalRow(type, price, symbol, ema9Val, ema21Val, ts, strategy);
      handleTradeLogic(type, price, ts);
      updateStatsUI();
    }

    function resetState() {
      closes = [];
      ema9 = null;
      ema21 = null;
      prevEma9 = null;
      prevEma21 = null;
      lastPrice = null;
      lastSignal = null;

      atr = null;
      prevClose = null;
      utTrend = null;
      utLine = null;

      signals = [];
      trades = [];
      openPosition = null;

      signalsBody.innerHTML = "";
      lastCloseEl.textContent = "‚Äì ‚Äì ‚Äì";
      lastCandleInfo.textContent = "Esperando datos‚Ä¶";
      setPriceDisplay(symbolSelect.value, null);
      setPriceChangeDisplay(null, null);
      updateEmaDisplay(symbolSelect.value);
      updateUtDisplay(symbolSelect.value);
      setSignalBanner(null, null, symbolSelect.value, Date.now());
      updatePositionFooter(symbolSelect.value);
      updateStatsUI();
    }

    // ===== DATA: HIST√ìRICO =====
    async function loadInitialKlines(symbol, interval) {
      const url =
        `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=60`;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        closes = [];
        atr = null;
        prevClose = null;
        utTrend = null;
        utLine = null;

        for (let i = 0; i < data.length; i++) {
          const row = data[i];
          const high = parseFloat(row[2]);
          const low = parseFloat(row[3]);
          const close = parseFloat(row[4]);

          closes.push(close);
          if (i === data.length - 1) lastPrice = close;

          // ATR
          let tr;
          if (prevClose === null) {
            tr = high - low;
            atr = tr;
          } else {
            tr = Math.max(
              high - low,
              Math.abs(high - prevClose),
              Math.abs(low - prevClose)
            );
            atr = atr === null
              ? tr
              : ((atr * (ATR_PERIOD - 1)) + tr) / ATR_PERIOD;
          }
          prevClose = close;

          // EMAs
          const K_EMA9 = 2 / (9 + 1);
          const K_EMA21 = 2 / (21 + 1);
          ema9 = computeEMA(ema9, close, K_EMA9);
          ema21 = computeEMA(ema21, close, K_EMA21);

          // UT style stop
          if (utLine === null) {
            utLine = close;
            utTrend = "FLAT";
          } else {
            if (close > utLine) {
              utTrend = "LONG";
              utLine = Math.max(utLine, close - ATR_MULT * atr);
            } else if (close < utLine) {
              utTrend = "SHORT";
              utLine = Math.min(utLine, close + ATR_MULT * atr);
            }
          }
        }

        setPriceDisplay(symbol, lastPrice);
        setPriceChangeDisplay(closes[0], lastPrice);
        updateEmaDisplay(symbol);
        updateUtDisplay(symbol);
        lastCloseEl.textContent = formatPriceBySymbol(symbol, lastPrice);
        lastCandleInfo.textContent =
          `Hist√≥rico precargado (${closes.length} velas)`;
      } catch (err) {
        console.error("Error al cargar klines:", err);
        lastCandleInfo.textContent =
          "Error al precargar velas: " + (err && err.message ? err.message : err);
      }
    }

    // ===== DATA: STREAM =====
    function connectStream() {
      const symbol = symbolSelect.value.toUpperCase();
      const interval = intervalSelect.value;

      resetState();
      symbolLabel.textContent = `${symbol} ¬∑ ${interval.toUpperCase()}`;
      footerStream.textContent = `${symbol.toLowerCase()}@kline_${interval}`;

      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close(1000, "Reset connection");
      }

      setConnectionState("connecting", "Cargando velas iniciales‚Ä¶");

      loadInitialKlines(symbol, interval).then(() => {
        const streamName = `${symbol.toLowerCase()}@kline_${interval}`;
        const url = `wss://stream.binance.com/ws/${streamName}`;

        try {
          socket = new WebSocket(url);
        } catch (e) {
          console.error("Error creando WebSocket:", e);
          setConnectionState("error", "No se pudo crear WebSocket");
          return;
        }

        socket.onopen = () => {
          setConnectionState("connected", "Conectado a Binance");
        };

        socket.onclose = () => {
          setConnectionState("disconnected", "Conexi√≥n cerrada");
        };

        socket.onerror = (ev) => {
          console.error("WebSocket error:", ev);
          setConnectionState("error", "Error de conexi√≥n (ver consola)");
        };

        socket.onmessage = (event) => {
          const data = JSON.parse(event.data);
          const k = data.k;
          const close = parseFloat(k.c);
          const high = parseFloat(k.h);
          const low = parseFloat(k.l);
          const isFinal = k.x;
          const openTime = k.t;
          const closeTime = k.T;
          lastPrice = close;

          setPriceDisplay(symbol, lastPrice);
          if (closes.length > 0) {
            setPriceChangeDisplay(closes[0], lastPrice);
          }

          if (isFinal) {
            // Actualizamos ATR
            let tr;
            if (prevClose === null) {
              tr = high - low;
              atr = tr;
            } else {
              tr = Math.max(
                high - low,
                Math.abs(high - prevClose),
                Math.abs(low - prevClose)
              );
              atr = atr === null
                ? tr
                : ((atr * (ATR_PERIOD - 1)) + tr) / ATR_PERIOD;
            }
            prevClose = close;

            closes.push(close);
            if (closes.length > 300) closes.shift();

            const K_EMA9 = 2 / (9 + 1);
            const K_EMA21 = 2 / (21 + 1);

            prevEma9 = ema9;
            prevEma21 = ema21;

            ema9 = computeEMA(ema9, close, K_EMA9);
            ema21 = computeEMA(ema21, close, K_EMA21);

            updateEmaDisplay(symbol);

            lastCloseEl.textContent = formatPriceBySymbol(symbol, close);
            lastCandleInfo.textContent =
              `Vela cerrada ¬∑ ${formatTime(closeTime)} ¬∑ Vol: ${parseFloat(k.v).toFixed(3)}`;

            // UT style trailing stop
            let prevUtTrend = utTrend;
            if (utLine === null) {
              utLine = close;
              utTrend = "FLAT";
            } else {
              if (close > utLine) {
                utTrend = "LONG";
                utLine = Math.max(utLine, close - ATR_MULT * atr);
              } else if (close < utLine) {
                utTrend = "SHORT";
                utLine = Math.min(utLine, close + ATR_MULT * atr);
              }
            }
            updateUtDisplay(symbol);

            // ---- Se√±ales EMA cross ----
            if (
              prevEma9 !== null &&
              prevEma21 !== null &&
              ema9 !== null &&
              ema21 !== null
            ) {
              let newSignal = null;
              if (prevEma9 <= prevEma21 && ema9 > ema21) {
                newSignal = "BUY";
              } else if (prevEma9 >= prevEma21 && ema9 < ema21) {
                newSignal = "SELL";
              }
              if (newSignal && newSignal !== lastSignal) {
                lastSignal = newSignal;
                setSignalBanner(newSignal, close, symbol, closeTime);
                registerSignal(newSignal, close, symbol, ema9, ema21, closeTime, "EMA");
              }
            }

            // ---- Se√±ales UT style (cambio de tendencia) ----
            if (prevUtTrend && utTrend && prevUtTrend !== utTrend) {
              const utSignal = utTrend === "LONG" ? "BUY" : "SELL";
              setSignalBanner(utSignal, close, symbol, closeTime);
              registerSignal(utSignal, close, symbol, ema9, ema21, closeTime, "UT");
            }
          } else {
            lastCandleInfo.textContent =
              `Vela en curso ¬∑ ${formatTime(openTime)} ‚Üí ${formatTime(closeTime)}`;
          }
        };
      });
    }

    // ===== EVENTOS UI =====
    connectBtn.addEventListener("click", connectStream);
    symbolSelect.addEventListener("change", connectStream);
    intervalSelect.addEventListener("change", connectStream);
    window.addEventListener("load", connectStream);
  </script>
</body>
</html>
